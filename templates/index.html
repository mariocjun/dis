<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasound Benchmark - Dark Science</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-cpp: #00d2ff;
            --accent-py: #ffc107;
            --accent-success: #00ff88;
            --accent-danger: #ff4757;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        /* KPI Cards */
        .kpi-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            border-color: #555;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Terminal Window */
        .terminal-window {
            background-color: #000;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .terminal-line {
            margin: 2px 0;
            font-size: 0.85rem;
        }

        .log-info {
            color: #aaa;
        }

        .log-error {
            color: var(--accent-danger);
        }

        .log-success {
            color: var(--accent-success);
        }



        /* Result Cards */
        .result-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .result-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.02);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            font-size: 0.9rem;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        /* Buttons */
        .btn-glow {
            background: linear-gradient(45deg, var(--accent-cpp), #00a8cc);
            border: none;
            color: #000;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            transition: all 0.3s;
        }

        .btn-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.5);
            color: #000;
        }

        .btn-glow:disabled {
            background: #444;
            color: #888;
            box-shadow: none;
            transform: none;
        }

        /* Animations */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .status-pulse {
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        /* Table */
        .table-dark-custom {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        .table-dark-custom th,
        .table-dark-custom td {
            border-color: var(--border-color);
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4" style="max-width: 1400px;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="fw-bold mb-0"><i class="fa-solid fa-wave-square me-3"
                        style="color: var(--accent-cpp);"></i>Benchmark Ultrasound</h1>
                <p class="text-secondary mb-0 mt-1">Comparação de Reconstrução de Imagens: C++ (CGNR/Sparse) vs Python
                    (Numpy)</p>
            </div>
            <button id="btnStart" class="btn btn-glow" onclick="startBenchmark()">
                <i class="fa-solid fa-play me-2"></i>Iniciar Benchmark
            </button>
        </div>

        <!-- KPIs -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-label">Status</div>
                    <div id="statusText" class="kpi-value" style="font-size: 1.5rem;">Pronto</div>
                    <div class="progress" style="height: 6px; background-color: #333;">
                        <div id="progressBar" class="progress-bar"
                            style="width: 0%; background-color: var(--accent-cpp);"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-label">Total Processado</div>
                    <div id="kpiCount" class="kpi-value">0/6</div>
                    <i class="fa-solid fa-list-check text-secondary"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-label">Speedup Médio</div>
                    <div id="kpiSpeedup" class="kpi-value" style="color: var(--accent-success);">0.0x</div>
                    <small class="text-secondary">Python / C++</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-label">Tempo Total (C++)</div>
                    <div id="kpiTotalTimeCpp" class="kpi-value" style="color: var(--accent-cpp);">0.0s</div>
                    <i class="fa-solid fa-bolt text-secondary"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Top: Results Feed (Full Width) -->
            <div class="col-12">
                <h2 class="h5 text-secondary mb-3 text-uppercase fs-6 ls-1">Feed de Resultados</h2>
                <div id="resultsContainer">
                    <!-- Results will be injected here -->
                </div>
            </div>
        </div>

        <!-- Bottom: Charts & Logs -->
        <div class="row g-4 mt-2">
            <!-- Charts -->
            <div class="col-lg-8">
                <h2 class="h5 text-secondary mb-3 text-uppercase fs-6 ls-1">Performance Analytics</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body">
                                <canvas id="timeChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-body">
                                <canvas id="speedupChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="col-lg-4">
                <h2 class="h5 text-secondary mb-3 text-uppercase fs-6 ls-1">
                    <i class="fa-solid fa-terminal me-2"></i>Logs do Sistema
                </h2>
                <div class="terminal-window" id="logTerminal" style="height: 250px;">
                    <div class="terminal-line"><span class="log-info">System initialized. Waiting for commands...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking Table (Bottom) -->
        <div id="rankingSection" class="mt-5 d-none">
            <h2 class="h5 text-secondary mb-3 text-uppercase fs-6 ls-1">Resumo Final</h2>
            <div class="table-responsive">
                <table class="table table-dark-custom table-hover">
                    <thead>
                        <tr>
                            <th>Cenário</th>
                            <th>Tempo C++ (s)</th>
                            <th>Tempo Py (s)</th>
                            <th>Speedup</th>
                            <th>Iters (C++/Py)</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Utils ---
        function addLog(msg, type = 'info') {
            const term = document.getElementById('logTerminal');
            if (!term) return;

            let colorClass = 'log-info';
            if (type === 'error' || msg.toLowerCase().includes('erro') || msg.toLowerCase().includes('fail')) colorClass = 'log-error';
            else if (type === 'success' || msg.toLowerCase().includes('sucesso') || msg.toLowerCase().includes('pronto')) colorClass = 'log-success';

            term.innerHTML += `<div class="terminal-line"><span class="${colorClass}">> ${msg}</span></div>`;
            term.scrollTop = term.scrollHeight;
        }

        // --- Global Error Handler ---
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            addLog(`BSOD (JS Error): ${msg} at line ${lineNo}`, 'error');
            return false;
        };

        // --- Init Socket ---
        addLog(`Inicializando Socket.IO... (Origin: ${window.location.host})`);

        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            transports: ['polling', 'websocket'],
            upgrade: true
        });

        // --- State ---
        let processedCount = 0;
        const totalScenarios = 6;
        let totalSpeedup = 0;
        let totalTimeCpp = 0;
        let timeChart, speedupChart;

        // --- Charts Init ---
        function initCharts() {
            const ctxTime = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(ctxTime, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'C++', data: [], backgroundColor: '#00d2ff', borderRadius: 4 },
                        { label: 'Python', data: [], backgroundColor: '#ffc107', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#aaa' } } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { grid: { display: false }, ticks: { color: '#aaa', font: { size: 10 } } }
                    }
                }
            });

            const ctxSpeedup = document.getElementById('speedupChart').getContext('2d');
            speedupChart = new Chart(ctxSpeedup, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Speedup (Py/Cpp)',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { display: false }
                    }
                }
            });
        }

        // --- Core Functions ---
        function startBenchmark() {
            if (!socket.connected) {
                addLog("Erro: Não conectado ao servidor.", 'error');
                return;
            }

            // Reset UI
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('rankingTableBody').innerHTML = '';
            document.getElementById('rankingSection').classList.add('d-none');
            // document.getElementById('logTerminal').innerHTML = ''; // Keep connection logs

            processedCount = 0;
            totalSpeedup = 0;
            totalTimeCpp = 0;
            updateKPIs();

            // Reset Charts
            timeChart.data.labels = [];
            timeChart.data.datasets.forEach(bs => bs.data = []);
            timeChart.update();
            speedupChart.data.labels = [];
            speedupChart.data.datasets[0].data = [];
            speedupChart.update();

            // Set Loading state
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStart').innerHTML = '<i class="fa-solid fa-circle-notch fa-spin me-2"></i>Rodando...';
            setStatus('Rodando...', 'var(--text-primary)', true);

            addLog("Enviando comando 'start_benchmark'...");
            socket.emit('start_benchmark');
        }

        function updateKPIs() {
            document.getElementById('kpiCount').innerText = `${processedCount}/${totalScenarios}`;
            const avgSpeedup = processedCount > 0 ? (totalSpeedup / processedCount).toFixed(2) : "0.00";
            document.getElementById('kpiSpeedup').innerText = `${avgSpeedup}x`;
            document.getElementById('kpiTotalTimeCpp').innerText = `${totalTimeCpp.toFixed(2)}s`;

            const progress = (processedCount / totalScenarios) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function setStatus(text, color, pulse = false) {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.style.color = color;
            if (pulse) el.classList.add('status-pulse');
            else el.classList.remove('status-pulse');
        }

        function createResultCard(data) {
            const cardId = `card-${Date.now()}`;
            const safeImgCpp = `${data.img_cpp}?t=${Date.now()}`;
            const safeImgPy = `${data.img_py}?t=${Date.now()}`;

            const html = `
            <div class="result-card fade-in-up">
                <div class="result-header">
                    <div>
                        <span class="badge bg-secondary me-2">${data.model}</span>
                        <strong class="text-white">${data.filename}</strong>
                    </div>
                    <div class="text-end">
                        <span class="text-success fw-bold" style="font-family: 'Roboto Mono'">${data.speedup.toFixed(2)}x Speedup</span>
                    </div>
                </div>
                <div class="p-4">
                    <!-- Images Row (Large) -->
                    <div class="row g-4 mb-4">
                        <div class="col-6 text-center">
                            <div class="text-uppercase small text-secondary mb-2" style="font-size: 0.85rem; letter-spacing: 2px;">Python (Numpy)</div>
                            <div class="bg-black p-2 rounded border border-dark">
                                <img src="${safeImgPy}" class="img-fluid" style="width: 100%; object-fit: contain; image-rendering: pixelated;" alt="Python">
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="text-uppercase small text-secondary mb-2" style="font-size: 0.85rem; letter-spacing: 2px;">C++ (CGNR)</div>
                            <div class="bg-black p-2 rounded border border-dark">
                                <img src="${safeImgCpp}" class="img-fluid" style="width: 100%; object-fit: contain; image-rendering: pixelated;" alt="C++">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Row (Minimalist) -->
                    <div class="d-flex justify-content-center flex-wrap gap-5 text-center mt-3 pt-3 border-top border-dark">
                        <div>
                            <div class="text-secondary small text-uppercase" style="font-size: 0.7rem;">Tempo C++</div>
                            <div class="fs-5 fw-bold" style="color: var(--accent-cpp)">${data.time_cpp.toFixed(4)}s</div>
                        </div>
                        <div>
                            <div class="text-secondary small text-uppercase" style="font-size: 0.7rem;">Tempo Python</div>
                            <div class="fs-5 fw-bold" style="color: var(--accent-py)">${data.time_py.toFixed(4)}s</div>
                        </div>
                        <div>
                            <div class="text-secondary small text-uppercase" style="font-size: 0.7rem;">Iters C++</div>
                            <div class="fs-5 fw-bold text-white">${data.iters_cpp}</div>
                        </div>
                        <div>
                            <div class="text-secondary small text-uppercase" style="font-size: 0.7rem;">Iters Python</div>
                            <div class="fs-5 fw-bold text-white">${data.iters_py}</div>
                        </div>
                    </div>
                </div>
            </div>`;

            const div = document.createElement('div');
            div.innerHTML = html;
            document.getElementById('resultsContainer').prepend(div); // Newest first

            // Update Table
            const row = `<tr>
                <td>${data.filename}</td>
                <td style="color: var(--accent-cpp)">${data.time_cpp.toFixed(4)}</td>
                <td style="color: var(--accent-py)">${data.time_py.toFixed(4)}</td>
                <td class="fw-bold text-success">${data.speedup.toFixed(2)}x</td>
                <td>${data.iters_cpp} / ${data.iters_py}</td>
            </tr>`;
            document.getElementById('rankingTableBody').innerHTML += row;
        }

        // --- Socket Events ---

        // Disable start initially
        document.getElementById('btnStart').disabled = true;
        setStatus('Desconectado', 'var(--accent-danger)');

        socket.on('connect', () => {
            addLog(`Conectado ao servidor! ID: ${socket.id} `, 'success');
            document.getElementById('btnStart').disabled = false;
            setStatus('Pronto', 'var(--accent-success)');
        });

        socket.on('connect_error', (error) => {
            addLog(`Erro de conexão: ${error} `, 'error');
            setStatus('Erro Conexão', 'var(--accent-danger)');
            document.getElementById('btnStart').disabled = true;
        });

        socket.on('disconnect', (reason) => {
            addLog(`Desconectado: ${reason}`, 'error');
            document.getElementById('btnStart').disabled = true;
            setStatus('Desconectado', 'var(--accent-danger)');
        });

        socket.on('log', (msg) => {
            addLog(msg.data);
        });

        socket.on('new_result', (data) => {
            processedCount++;
            totalSpeedup += data.speedup;
            totalTimeCpp += data.time_cpp;
            updateKPIs();
            createResultCard(data);

            // Update Charts
            timeChart.data.labels.push(data.filename);
            timeChart.data.datasets[0].data.push(data.time_cpp);
            timeChart.data.datasets[1].data.push(data.time_py);
            timeChart.update();

            speedupChart.data.labels.push(data.filename);
            speedupChart.data.datasets[0].data.push(data.speedup);
            speedupChart.update();
        });

        socket.on('benchmark_finished', () => {
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').innerHTML = '<i class="fa-solid fa-play me-2"></i>Iniciar Benchmark';
            setStatus('Finalizado', 'var(--accent-success)');
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('rankingSection').classList.remove('d-none');
            addLog("Benchmark concluído com sucesso.", 'success');
        });

        // Initialize
        initCharts();
    </script>
</body>

</html>